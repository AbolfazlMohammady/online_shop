# ุฏุฑฺฏุงู ูพุฑุฏุงุฎุช ุฒุฑูโูพุงู - ุฒุจุง ุดุงูพ

## ูุนุฑู

ุงู ูพุฑูฺู ุดุงูู ฺฉูพุงุฑฺูโุณุงุฒ ฺฉุงูู ุฏุฑฺฏุงู ูพุฑุฏุงุฎุช ุฒุฑูโูพุงู ุจุฑุง ูุฑูุดฺฏุงู ุขููุงู ุฒุจุง ุดุงูพ ุงุณุช. ุณุณุชู ูพุฑุฏุงุฎุช ุจู ุตูุฑุช ฺฉุงูู ูพุงุฏูโุณุงุฒ ุดุฏู ู ุดุงูู ุชูุงู ูุงุจูุชโูุง ููุฑุฏ ูุงุฒ ุจุฑุง ูพุฑุฏุงุฎุช ุงูฺฉุชุฑููฺฉ ุงุณุช.

## ูฺฺฏโูุง

โ **ูพุฑุฏุงุฎุช ุงูู**: ุงุณุชูุงุฏู ุงุฒ ูพุฑูุชฺฉู HTTPS ู API ูุง ุงูู ุฒุฑูโูพุงู  
โ **ูพฺฏุฑ ฺฉุงูู**: ุซุจุช ุชูุงู ุฌุฒุฆุงุช ูพุฑุฏุงุฎุช ู ูุถุนุชโูุง  
โ **ุจุงุฒฺฏุดุช ุฎูุฏฺฉุงุฑ**: ุจุงุฒฺฏุดุช ุฎูุฏฺฉุงุฑ ฺฉุงุฑุจุฑ ุจุนุฏ ุงุฒ ูพุฑุฏุงุฎุช  
โ **ูุงฺฏ ฺฉุงูู**: ุซุจุช ุชูุงู ุนููุงุช ุฏุฑ ูุงู ู ฺฉูุณูู  
โ **ูุฏุฑุช ุฎุทุง**: ูุฏุฑุช ฺฉุงูู ุฎุทุงูุง ู ูพุงูโูุง ููุงุณุจ  
โ **ูพูู ูุฏุฑุช**: ููุงุด ูุถุนุช ูพุฑุฏุงุฎุช ุฏุฑ ูพูู ุงุฏูู  

## ูุตุจ ู ุฑุงูโุงูุฏุงุฒ

### 1. ูุตุจ ูุงุจุณุชฺฏโูุง

```bash
pipenv install requests
```

### 2. ุชูุธูุงุช ุฏุฑฺฏุงู ูพุฑุฏุงุฎุช

ุฏุฑ ูุงู `shop/payment_gateway.py` ุชูุธูุงุช ุฒุฑ ุฑุง ุจุฑุฑุณ ฺฉูุฏ:

```python
# ุชูุธูุงุช ุฏุฑฺฏุงู ูพุฑุฏุงุฎุช
ZARINPAL_MERCHANT_ID = '44a8726a-97be-43b4-ad67-d4e7fe4eae72'
ZARINPAL_SANDBOX = True  # ุฏุฑ ูุญุท ุชููุฏ False ฺฉูุฏ
```

### 3. ุงุฌุฑุง ูุงฺฏุฑุดูโูุง

```bash
python manage.py makemigrations
python manage.py migrate
```

### 4. ุชุณุช ุณุณุชู

```bash
python manage.py test_payment_gateway
```

## ูุญูู ุงุณุชูุงุฏู

### 1. ุงุฌุงุฏ ุณูุงุฑุด

```python
from shop.models import Order
from shop.payment_gateway import payment_gateway

# ุงุฌุงุฏ ุณูุงุฑุด
order = Order.objects.create(
    user=request.user,
    status='pending',
    total_amount=150000,  # 150,000 ุชููุงู
    # ... ุณุงุฑ ููุฏูุง
)
```

### 2. ุดุฑูุน ูพุฑุฏุงุฎุช

```python
# ุงุฌุงุฏ ุฏุฑุฎูุงุณุช ูพุฑุฏุงุฎุช
callback_url = request.build_absolute_uri(
    reverse('shop:payment_callback', kwargs={'order_id': order.id})
)

payment_result = payment_gateway.create_payment_request(order, callback_url)

if payment_result['success']:
    # ูุฏุงุช ฺฉุงุฑุจุฑ ุจู ุฏุฑฺฏุงู ูพุฑุฏุงุฎุช
    return redirect(payment_result['payment_url'])
```

### 3. ุชุงุฏ ูพุฑุฏุงุฎุช

```python
# ุฏุฑ callback
verification_result = payment_gateway.verify_payment(authority, amount)

if verification_result['success']:
    order.mark_as_paid(verification_result['ref_id'], authority)
else:
    order.mark_as_payment_failed(verification_result['error_code'])
```

## ุณุงุฎุชุงุฑ ูุงูโูุง

```
shop/
โโโ payment_gateway.py          # ฺฉูุงุณ ุงุตู ุฏุฑฺฏุงู ูพุฑุฏุงุฎุช
โโโ models.py                   # ูุฏู Order ุจุง ููุฏูุง ูพุฑุฏุงุฎุช
โโโ views.py                    # ูููุง ูพุฑุฏุงุฎุช
โโโ urls.py                     # URL ูุง ูพุฑุฏุงุฎุช
โโโ admin.py                    # ูพูู ุงุฏูู ุจุง ุงุทูุงุนุงุช ูพุฑุฏุงุฎุช
โโโ templates/shop/
    โโโ order_detail.html       # ุตูุญู ุฌุฒุฆุงุช ุณูุงุฑุด
    โโโ payment_status.html     # ุตูุญู ูุถุนุช ูพุฑุฏุงุฎุช
```

## ููุฏูุง ุฌุฏุฏ ุฏุฑ ูุฏู Order

- `payment_authority`: ุดูุงุณู ูุฑุฌุน ูพุฑุฏุงุฎุช
- `payment_ref_id`: ุดูุงุฑู ุชุฑุงฺฉูุด
- `payment_status_code`: ฺฉุฏ ูุถุนุช ูพุฑุฏุงุฎุช
- `payment_description`: ุชูุถุญุงุช ูพุฑุฏุงุฎุช
- `payment_date`: ุชุงุฑุฎ ูพุฑุฏุงุฎุช

## URL ูุง ูพุฑุฏุงุฎุช

- `initiate_payment`: ุดุฑูุน ูุฑุขูุฏ ูพุฑุฏุงุฎุช
- `payment_callback`: ุจุงุฒฺฏุดุช ุงุฒ ุฏุฑฺฏุงู ูพุฑุฏุงุฎุช
- `payment_status`: ููุงุด ูุถุนุช ูพุฑุฏุงุฎุช

## ูุงฺฏโฺฏุฑ

ุชูุงู ุนููุงุช ูพุฑุฏุงุฎุช ุฏุฑ ูุงู `logs/payment.log` ู ฺฉูุณูู ุซุจุช ูโุดูุฏ:

```
๐ณ ุฏุฑุฎูุงุณุช ูพุฑุฏุงุฎุช ุงุฌุงุฏ ุดุฏ!
   ุดูุงุฑู ุณูุงุฑุด: #123
   ฺฉุงุฑุจุฑ: test_user
   ูุจูุบ: 150,000 ุชููุงู
   Authority: A123456789012345678901234567890123
   ุชุงุฑุฎ: 2025-08-20 10:30:00
==================================================
```

## ุชุณุช

### ุชุณุช ุฏุฑฺฏุงู ูพุฑุฏุงุฎุช

```bash
python manage.py test_payment_gateway
```

### ุชุณุช ุฏุณุช

1. ุงุฌุงุฏ ุณูุงุฑุด ุฏุฑ ุณุงุช
2. ฺฉูฺฉ ุฑู ุฏฺฉูู "ูพุฑุฏุงุฎุช ุจุง ุฒุฑูโูพุงู"
3. ูุฏุงุช ุจู ุฏุฑฺฏุงู ูพุฑุฏุงุฎุช
4. ุจุงุฒฺฏุดุช ู ุชุงุฏ ูพุฑุฏุงุฎุช

## ูฺฉุงุช ููู

### ูุญุท ุชุณุช (Sandbox)
- ุฏุฑ ูุญุท ุชูุณุนู ุงุฒ `ZARINPAL_SANDBOX = True` ุงุณุชูุงุฏู ฺฉูุฏ
- ุจุฑุง ุชุณุช ุงุฒ ฺฉุงุฑุชโูุง ุชุณุช ุฒุฑูโูพุงู ุงุณุชูุงุฏู ฺฉูุฏ

### ูุญุท ุชููุฏ (Production)
- `ZARINPAL_SANDBOX = False` ฺฉูุฏ
- IP ุณุฑูุฑ ุฑุง ุฏุฑ ูพูู ุฒุฑูโูพุงู ุซุจุช ฺฉูุฏ
- ุงุฒ SSL ูุนุชุจุฑ ุงุณุชูุงุฏู ฺฉูุฏ

### ุงููุช
- ุชูุงู ุฏุฑุฎูุงุณุชโูุง ุงุฒ ุทุฑู HTTPS ุงูุฌุงู ูโุดูุฏ
- ุงุนุชุจุงุฑุณูุฌ ฺฉุงูู ุฏุงุฏูโูุง ุงูุฌุงู ูโุดูุฏ
- ูุงฺฏ ฺฉุงูู ุชูุงู ุนููุงุช

## ูพุดุชุจุงู

ุฏุฑ ุตูุฑุช ุจุฑูุฒ ูุดฺฉู:

1. ุจุฑุฑุณ ูุงฺฏโูุง ุฏุฑ `logs/payment.log`
2. ุจุฑุฑุณ ฺฉูุณูู ุจุฑุง ูพุงูโูุง ุฎุทุง
3. ุชุณุช ุจุง ุฏุณุชูุฑ `test_payment_gateway`
4. ุจุฑุฑุณ ุชูุธูุงุช ุฏุฑฺฏุงู ุฏุฑ ูพูู ุฒุฑูโูพุงู

## ููุงุจุน

- [ูุณุชูุฏุงุช ุฒุฑูโูพุงู](https://docs.zarinpal.com/)
- [API Reference](https://docs.zarinpal.com/payment-gateway/)
- [ฺฉุฏูุง ุฎุทุง](https://docs.zarinpal.com/payment-gateway/error-codes/)
